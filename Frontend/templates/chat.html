{% extends 'base.html' %}
{% block content %}
<div class="chat-container">
  <h2>Discussion avec {{ recipient.username }}</h2>

  <!-- Zone des messages -->
  <div class="message-box" id="messages">
    <!-- Les messages seront chargés dynamiquement -->
  </div>

  <!-- Champ pour envoyer un message -->
  <form id="message-form">
    <input type="hidden" id="recipient_id" value="{{ recipient.id }}">
    <textarea id="message-input" placeholder="Écrivez votre message ici..." required></textarea>
    <button type="submit">Envoyer</button>
  </form>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const recipient_id = document.getElementById('recipient_id').value;
    const messageBox = document.getElementById('messages');

    // Charger les anciens messages
    fetch(`/get-messages?receiver_id=${recipient_id}`)
      .then(response => response.json())
      .then(messages => {
        messages.forEach(msg => {
          const messageDiv = document.createElement('div');
          messageDiv.classList.add('message', msg.sender === 'Moi' ? 'sent' : 'received');
          messageDiv.innerHTML = `
            <p class="content">
              <strong>${msg.sender}</strong>: ${msg.content}
            </p>
            <span class="timestamp">${msg.timestamp}</span>
          `;
          messageBox.appendChild(messageDiv);
        });
        messageBox.scrollTop = messageBox.scrollHeight; // Scroll to the bottom
      })
      .catch(err => console.error('Erreur lors du chargement des messages:', err));
  });
</script>

{% endblock %}
