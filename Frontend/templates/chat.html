{% extends 'base.html' %}
{% block content %}
<div class="chat-container">
  <h2>Discussion avec {{ recipient.username }}</h2>

  <!-- Zone des messages -->
  <div class="message-box" id="messages">
    <!-- Les messages seront chargés dynamiquement -->
  </div>

  <!-- Champ pour envoyer un message -->
  <form method="post" action="/send-message" class="message-form">
    <input type="hidden" name="recipient_id" value="{{ recipient.id }}">
    <textarea name="message" placeholder="Écrivez votre message ici..." required></textarea>
    <button type="submit">Envoyer</button>
  </form>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.min.js"></script>
<script>
  const socket = io.connect();

  // Rejoindre la room pour recevoir des messages
  socket.emit('join_chat', { user_id: {{ user.id }} });

  // Écouter les messages reçus
  socket.on('receive_message', (data) => {
    const messageBox = document.getElementById('messages');
    const messageDiv = document.createElement('div');
    messageDiv.classList.add('message', 'received');
    messageDiv.innerHTML = `
      <p class="content">
        <strong>${data.sender}</strong>: ${data.content}
      </p>
      <span class="timestamp">${data.timestamp}</span>
    `;
    messageBox.appendChild(messageDiv);
    messageBox.scrollTop = messageBox.scrollHeight;
  });

  // Envoyer un message
  const form = document.querySelector(".message-form");
  form.onsubmit = (e) => {
    e.preventDefault();
    const formData = new FormData(form);
    const message = formData.get('message');
    const recipient_id = formData.get('recipient_id');

    socket.emit('send_message', { message, recipient_id });
    form.reset();
  };
</script>


{% endblock %}

