{% extends 'base.html' %}
{% block content %}
<div style="display: flex;">
  <div style="margin-left: 0.5%; margin-right: 1.5%; padding-right: 3%;">
    <div class="dashboard-container1">
      <h2>CHAT!!</h2>
    
      <!-- Liste des utilisateurs -->
      <div class="user-list">
        <h3>Utilisateurs connectés</h3>
        <ul>
          {% for user in users %}
            <a href="/chat?user_id={{ user.id }}" class="chat-link">
              <div class="user-item">
                {{ user.username }}
              </div>
            </a>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>

  <div>
    <div class="chat-container">
      <h2>Discussion avec {{ recipient.username }}</h2>
    
      <!-- Zone des messages -->
      <div class="message-box" id="messages">
        <!-- Les messages seront chargés dynamiquement -->
      </div>
    
      <!-- Champ pour envoyer un message -->
      <form id="message-form" action="/send-message" method="POST" class="message-form" autocomplete="off">
        <input type="hidden" id="recipient_id" name="recipient_id" value="{{ recipient.id }}">
        <div style="display: flex;">
          <textarea id="message-input" class="message-input" name="message" placeholder="Écrivez votre message ici..." required></textarea>
          <button id="send_button" type="submit">
            <svg id="send_button_icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="12">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" />
            </svg>
            <svg id="done_button_icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="opacity: 0;" width="0">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span id="button_text">Send</span>
        </button>
        </div>
      </form>
    </div>
  </div>
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.min.js"></script>
<script>
  // CSS js
  // const socket = io.connect();
  


  //End CSS Js
  const recipient_id = document.getElementById('recipient_id').value;


  document.addEventListener('DOMContentLoaded', function () {
    //const recipient_id = document.getElementById('recipient_id').value;

    // //Rejoindre la discussion 
    // const socket = io.connect('wss://192.168.150.143:80', {
    //   secure: true,
    //   rejectUnauthorized: false
    // });
    // //socket.emit('join_room', {user_id: recipient_id });
    //socket.emit('join_room', {user_id:'{{user.id}}' });

    // Charger les anciens messages
    fetch(`/get-messages?receiver_id=${recipient_id}`)
      .then(response => response.json())
      .then(messages => {
        if (!Array.isArray(messages)) {
          console.error("Erreur lors du chargement des messages: La réponse n'est pas un tableau", messages);
          return;
        }

        const messageBox = document.getElementById("messages");
        messages.forEach(msg => {
          const messageDiv = document.createElement("div");
          messageDiv.classList.add("message", msg.sender === "Moi" ? "sent" : "received");
          messageDiv.innerHTML = `
            <p class="content">
              <strong>${msg.sender}</strong>: ${msg.content}
            </p>
            <span class="timestamp">${msg.timestamp}</span>
          `;
          messageBox.appendChild(messageDiv);
        });

        // Scroller vers le bas
        messageBox.scrollTop = messageBox.scrollHeight;
      })
      .catch(error => {
        console.error("Erreur lors du chargement des messages:", error);
      });
    });

    
  const socket = io.connect();
    // Fonction pour envoyer un message via WebSocket
  const form = document.getElementById("message-form");
  form.onsubmit = (e) => {
    e.preventDefault();

    const messageInput = document.getElementById("message-input");
    const message = messageInput.value;

    if (!message || !recipient_id) {
      console.error("Les données du formulaire sont incomplètes.");
      return;
    }

      // Envoyer le message via WebSocket
    socket.emit('send_message', { message, recipient_id });
    console.log("Message envoyé :", { message, recipient_id });
    messageInput.value= '';

    messageInput.value = ''; // Réinitialiser le champ
  };

  // Écouter les messages reçus en temps réel
  socket.on('receive_message', (data) => {
    const messageBox = document.getElementById("messages");
    const messageDiv = document.createElement("div");
    messageDiv.classList.add("message", "received");
    messageDiv.innerHTML = `
      <p><strong>${data.sender}</strong>: ${data.content}</p>
      <span class="timestamp">${data.timestamp}</span>
    `;
    messageBox.appendChild(messageDiv);
    messageBox.scrollTop = messageBox.scrollHeight;
  });

  
</script>

{% endblock %}
